<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€ - ìƒë‹´ ì‹ ì²­ ê´€ë¦¬</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            background: #000;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .admin-header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .contacts-table {
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .table-header {
            background: #000;
            color: #fff;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .refresh-btn {
            background: #FFD700;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .refresh-btn:hover {
            background: #FFA500;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .contact-row {
            transition: background-color 0.2s;
        }
        
        .contact-row:hover {
            background: #f8f9fa;
        }
        
        .contact-row.unread {
            background: #fff3cd;
            border-left: 4px solid #FFD700;
        }
        
        .read-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .read-btn:hover {
            background: #218838;
        }
        
        .read-btn.read {
            background: #6c757d;
            cursor: default;
        }
        
        .service-badge {
            background: #FFD700;
            color: #000;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .message-preview {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .chart-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .admin-container {
                padding: 10px;
            }
            
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .table-header {
                flex-direction: column;
                gap: 10px;
            }
            
            table {
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>ğŸ“Š ìƒë‹´ ì‹ ì²­ ê´€ë¦¬</h1>
                    <p>ì›¹ì‚¬ì´íŠ¸ë¥¼ í†µí•œ ìƒë‹´ ì‹ ì²­ ë‚´ì—­ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                </div>
                <button onclick="logout()" style="
                    background: #FFD700; 
                    color: #000; 
                    border: none; 
                    padding: 8px 16px; 
                    border-radius: 4px; 
                    cursor: pointer; 
                    font-weight: bold;
                    font-size: 0.9rem;
                ">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
        
        <div class="admin-stats">
            <div class="stat-card">
                <div class="stat-number" id="totalContacts">-</div>
                <div class="stat-label">ì „ì²´ ìƒë‹´ ì‹ ì²­</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unreadContacts">-</div>
                <div class="stat-label">ì½ì§€ ì•Šì€ ì‹ ì²­</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayContacts">-</div>
                <div class="stat-label">ì˜¤ëŠ˜ ì‹ ì²­</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgDailyContacts">-</div>
                <div class="stat-label">ì¼í‰ê·  ì‹ ì²­</div>
            </div>
        </div>
        
        <div class="charts-section">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">ğŸ“ˆ ì¼ë³„ ë¬¸ì˜ í˜„í™© (ìµœê·¼ 7ì¼)</div>
                </div>
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">ğŸ° ì„œë¹„ìŠ¤ë³„ ë¬¸ì˜ ë¶„í¬</div>
                </div>
                <div class="chart-container">
                    <canvas id="serviceChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="contacts-table">
            <div class="table-header">
                <h2>ìƒë‹´ ì‹ ì²­ ëª©ë¡</h2>
                <button class="refresh-btn" onclick="loadContacts()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="contactsList">
                <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <script>
        // ì¸ì¦ ì²´í¬
        function checkAuthentication() {
            const isAuthenticated = sessionStorage.getItem('adminAuthenticated') === 'true';
            const loginTime = parseInt(sessionStorage.getItem('adminLoginTime') || '0');
            const currentTime = new Date().getTime();
            const sessionTimeout = 2 * 60 * 60 * 1000; // 2ì‹œê°„
            
            if (!isAuthenticated || (currentTime - loginTime > sessionTimeout)) {
                // ì¸ì¦ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì„¸ì…˜ì´ ë§Œë£Œëœ ê²½ìš°
                sessionStorage.removeItem('adminAuthenticated');
                sessionStorage.removeItem('adminLoginTime');
                window.location.href = './admin-login.html';
                return false;
            }
            return true;
        }
        
        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        function logout() {
            sessionStorage.removeItem('adminAuthenticated');
            sessionStorage.removeItem('adminLoginTime');
            window.location.href = './admin-login.html';
        }
        
        // ì°¨íŠ¸ ê°ì²´ë“¤
        let dailyChart = null;
        let serviceChart = null;
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ ì²´í¬ í›„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', function() {
            if (checkAuthentication()) {
                loadStats();
                loadContacts();
                loadCharts();
            }
        });
        
        // í†µê³„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadStats() {
            if (!checkAuthentication()) return;
            
            try {
                const [contactsResponse, unreadResponse] = await Promise.all([
                    fetch('/api/admin/contacts'),
                    fetch('/api/admin/contacts/unread-count')
                ]);
                
                if (contactsResponse.ok && unreadResponse.ok) {
                    const contacts = await contactsResponse.json();
                    const unreadData = await unreadResponse.json();
                    
                    document.getElementById('totalContacts').textContent = contacts.length;
                    document.getElementById('unreadContacts').textContent = unreadData.unreadCount;
                    
                    // ì˜¤ëŠ˜ ì‹ ì²­ ìˆ˜ ê³„ì‚°
                    const today = new Date().toDateString();
                    const todayContacts = contacts.filter(contact => 
                        new Date(contact.createdAt).toDateString() === today
                    ).length;
                    document.getElementById('todayContacts').textContent = todayContacts;
                    
                    // ì¼í‰ê·  ì‹ ì²­ ìˆ˜ ê³„ì‚°
                    if (contacts.length > 0) {
                        const firstDate = new Date(contacts[contacts.length - 1].createdAt);
                        const lastDate = new Date(contacts[0].createdAt);
                        const daysDiff = Math.ceil((lastDate - firstDate) / (1000 * 60 * 60 * 24)) + 1;
                        const avgDaily = (contacts.length / daysDiff).toFixed(1);
                        document.getElementById('avgDailyContacts').textContent = avgDaily;
                    } else {
                        document.getElementById('avgDailyContacts').textContent = '0';
                    }
                }
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ìƒë‹´ ì‹ ì²­ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadContacts() {
            if (!checkAuthentication()) return;
            
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            
            try {
                const response = await fetch('/api/admin/contacts');
                
                if (response.ok) {
                    const contacts = await response.json();
                    displayContacts(contacts);
                    // ì°¨íŠ¸ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
                    createDailyChart(contacts);
                    createServiceChart(contacts);
                } else {
                    contactsList.innerHTML = '<div class="error">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
                }
            } catch (error) {
                console.error('ìƒë‹´ ì‹ ì²­ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                contactsList.innerHTML = '<div class="error">ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }
        
        // ìƒë‹´ ì‹ ì²­ ëª©ë¡ í‘œì‹œ
        function displayContacts(contacts) {
            const contactsList = document.getElementById('contactsList');
            
            if (contacts.length === 0) {
                contactsList.innerHTML = '<div class="loading">ìƒë‹´ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ì´ë¦„</th>
                        <th>ì´ë©”ì¼</th>
                        <th>ì „í™”ë²ˆí˜¸</th>
                        <th>ì„œë¹„ìŠ¤</th>
                        <th>ë©”ì‹œì§€</th>
                        <th>ì ‘ìˆ˜ì¼ì‹œ</th>
                        <th>ìƒíƒœ</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody>
                    ${contacts.map(contact => `
                        <tr class="contact-row ${!contact.isRead ? 'unread' : ''}">
                            <td>${contact.id}</td>
                            <td>${contact.name}</td>
                            <td>${contact.email}</td>
                            <td>${contact.phone}</td>
                            <td><span class="service-badge">${getServiceName(contact.service)}</span></td>
                            <td class="message-preview" title="${contact.message}">${contact.message}</td>
                            <td>${formatDate(contact.createdAt)}</td>
                            <td>${contact.isRead ? 'ì½ìŒ' : 'ì•ˆì½ìŒ'}</td>
                            <td>
                                <button class="read-btn ${contact.isRead ? 'read' : ''}" 
                                        onclick="markAsRead(${contact.id})" 
                                        ${contact.isRead ? 'disabled' : ''}>
                                    ${contact.isRead ? 'ì½ìŒ' : 'ì½ìŒ ì²˜ë¦¬'}
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            
            contactsList.innerHTML = '';
            contactsList.appendChild(table);
        }
        
        // ì„œë¹„ìŠ¤ ì´ë¦„ ë³€í™˜
        function getServiceName(service) {
            const serviceNames = {
                'responsive': 'ë°˜ì‘í˜• ì›¹ì‚¬ì´íŠ¸',
                'shopping': 'ì‡¼í•‘ëª° êµ¬ì¶•',
                'corporate': 'ê¸°ì—… í™ˆí˜ì´ì§€',
                'booking': 'ì˜ˆì•½ ì‹œìŠ¤í…œ',
                'maintenance': 'ìœ ì§€ë³´ìˆ˜',
                'custom': 'ë§ì¶¤ ê°œë°œ'
            };
            return serviceNames[service] || service;
        }
        
        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // ì°¨íŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadCharts() {
            if (!checkAuthentication()) return;
            
            try {
                const response = await fetch('/api/admin/contacts');
                if (response.ok) {
                    const contacts = await response.json();
                    createDailyChart(contacts);
                    createServiceChart(contacts);
                }
            } catch (error) {
                console.error('ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì¼ë³„ ë¬¸ì˜ í˜„í™© ì°¨íŠ¸ ìƒì„±
        function createDailyChart(contacts) {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            // ìµœê·¼ 7ì¼ ë°ì´í„° ì¤€ë¹„
            const last7Days = [];
            const dailyCounts = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last7Days.push(dateStr);
                
                const count = contacts.filter(contact => 
                    contact.createdAt.startsWith(dateStr)
                ).length;
                dailyCounts.push(count);
            }
            
            // ë‚ ì§œ í¬ë§·íŒ…
            const labels = last7Days.map(date => {
                const d = new Date(date);
                return `${d.getMonth() + 1}/${d.getDate()}`;
            });
            
            if (dailyChart) {
                dailyChart.destroy();
            }
            
            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ë¬¸ì˜ ìˆ˜',
                        data: dailyCounts,
                        borderColor: '#FFD700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#FFD700',
                        pointBorderColor: '#000',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: '#666'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#666'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        // ì„œë¹„ìŠ¤ë³„ ë¬¸ì˜ ë¶„í¬ ì°¨íŠ¸ ìƒì„±
        function createServiceChart(contacts) {
            const ctx = document.getElementById('serviceChart').getContext('2d');
            
            // ì„œë¹„ìŠ¤ë³„ ì¹´ìš´íŠ¸
            const serviceCounts = {};
            contacts.forEach(contact => {
                const serviceName = getServiceName(contact.service);
                serviceCounts[serviceName] = (serviceCounts[serviceName] || 0) + 1;
            });
            
            const labels = Object.keys(serviceCounts);
            const data = Object.values(serviceCounts);
            
            // ìƒ‰ìƒ íŒ”ë ˆíŠ¸
            const colors = [
                '#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', 
                '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'
            ];
            
            if (serviceChart) {
                serviceChart.destroy();
            }
            
            serviceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: '#fff',
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                color: '#666'
                            }
                        }
                    }
                }
            });
        }
        
        // ì½ìŒ ì²˜ë¦¬
        async function markAsRead(contactId) {
            if (!checkAuthentication()) return;
            
            try {
                const response = await fetch(`/api/admin/contacts/${contactId}/read`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    // ì„±ê³µ ì‹œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadStats();
                    loadContacts();
                    loadCharts();
                } else {
                    alert('ì½ìŒ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>
</html>
